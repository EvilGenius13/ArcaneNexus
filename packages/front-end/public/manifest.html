<!DOCTYPE html>
<html>
  <head>
    <title>Arcane Nexus Manifest Generator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      form {
        max-width: 600px;
      }
      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 8px;
        margin: 6px 0 12px 0;
        box-sizing: border-box;
      }
      button {
        padding: 10px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      .response {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <h2>Generate Project Manifest</h2>
    <form id="manifestForm">
      <label for="gameName">Game Name:</label>
      <input type="text" id="gameName" name="gameName" required />

      <label for="versionName">Version Name:</label>
      <input type="text" id="versionName" name="versionName" required />

      <label for="pathToProjectLogo">Path to Project Logo (optional):</label>
      <input type="text" id="pathToProjectLogo" name="pathToProjectLogo" />

      <label for="pathToProjectImageURL"
        >Path to Project Image URL (optional):</label
      >
      <input
        type="text"
        id="pathToProjectImageURL"
        name="pathToProjectImageURL"
      />

      <label for="executablePath">Executable Path (optional):</label>
      <input type="text" id="executablePath" name="executablePath" />

      <label for="files">Select Folder:</label>
      <input
        type="file"
        id="files"
        name="files"
        webkitdirectory
        directory
        multiple
        required
      />

      <button type="submit">Generate Manifest</button>
    </form>

    <div id="response" class="response" style="display: none"></div>

    <script>
      const form = document.getElementById("manifestForm");
      const responseDiv = document.getElementById("response");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const gameName = document.getElementById("gameName").value;
        const versionName = document.getElementById("versionName").value;
        const pathToProjectLogo =
          document.getElementById("pathToProjectLogo").value;
        const pathToProjectImageURL = document.getElementById(
          "pathToProjectImageURL"
        ).value;
        const executablePath = document.getElementById("executablePath").value;
        const filesInput = document.getElementById("files");
        const files = Array.from(filesInput.files);

        if (files.length === 0) {
          alert("Please select a folder.");
          return;
        }

        try {
          responseDiv.innerHTML = "<p>Generating manifest, please wait...</p>";
          responseDiv.style.display = "block";

          const manifest = await generateManifest({
            gameName,
            versionName,
            pathToProjectLogo,
            pathToProjectImageURL,
            executablePath,
            files,
          });

          const jsonFile = new File(
            [JSON.stringify(manifest, null, 2)],
            "manifest.json",
            {
              type: "application/json",
            }
          );

          const formData = new FormData();
          formData.append("gameName", gameName);
          formData.append("versionName", versionName);
          formData.append("file", jsonFile, "manifest.json");

          // Send the manifest to the server
          const res = await fetch("http://localhost:3000/api/files/upload", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();

          if (res.ok) {
            responseDiv.innerHTML = `<h3>${data.message}</h3>`;
          } else {
            responseDiv.innerHTML = `<h3 style="color: red;">${data.error}</h3>`;
          }
        } catch (error) {
          console.error("Error:", error);
          responseDiv.innerHTML = `<h3 style="color: red;">An error occurred while generating the manifest.</h3>`;
        }
      });

      async function generateManifest({
        gameName,
        versionName,
        pathToProjectLogo,
        pathToProjectImageURL,
        executablePath,
        files,
      }) {
        const ignoreList = [".DS_Store", ".log", ".tmp"];

        const manifest = {
          generatedAt: new Date().toISOString(),
          gameName: gameName,
          versionName: versionName,
          pathToProjectLogo: pathToProjectLogo,
          pathToProjectImageURL: pathToProjectImageURL,
          executablePath: executablePath,
          files: [],
        };

        const filePromises = files.map(async (file) => {
          const relativePath = file.webkitRelativePath || file.name;

          // Skip files based on ignore list
          if (shouldSkipFile(file.name, ignoreList)) {
            return null;
          }

          const arrayBuffer = await file.arrayBuffer();
          const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");

          return {
            path: relativePath.replace(/\\/g, "/"),
            size: file.size,
            hash: hashHex,
          };
        });

        const fileEntries = await Promise.all(filePromises);
        manifest.files = fileEntries.filter((entry) => entry !== null);

        return manifest;
      }

      function shouldSkipFile(fileName, ignoreFiles) {
        return ignoreFiles.some((pattern) => {
          if (pattern.startsWith(".")) {
            // Match by extension
            return fileName.endsWith(pattern);
          } else {
            // Match by exact file name
            return fileName === pattern;
          }
        });
      }
    </script>
  </body>
</html>
